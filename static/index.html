<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Subtitle Translator for Stremio</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ AI Subtitle Translator for Stremio</h1>
            <p class="subtitle">Search, translate, and upload subtitles automatically</p>
        </div>
        
        <div class="search-box">
            <div class="search-form">
                <input 
                    type="text" 
                    id="query" 
                    placeholder="Search for a movie or series (e.g., Breaking Bad)..."
                    onkeypress="if(event.key === 'Enter') searchMedia()"
                    aria-label="Search for movies or series"
                >
                <button onclick="searchMedia()" aria-label="Search">Search</button>
            </div>
        </div>

        <div id="loading" class="loading" role="status" aria-live="polite"></div>
        <div id="processing" class="loading" role="status" aria-live="polite"></div>

        <div id="media-section" style="display: none;">
            <div class="section">
                <h2>Search Results</h2>
                <div id="media-results" class="media-grid"></div>
            </div>
        </div>

        <div id="subtitle-section" style="display: none;">
            <div class="section">
                <h2>Available Subtitles</h2>
                <div id="subtitle-results" class="subtitle-list"></div>
            </div>
        </div>
    </div>

    <div id="fullscreen-loader" class="fullscreen-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">Loading...</div>
    </div>

    <script>
        async function searchMedia() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            showFullscreenLoader('Searching on IMDb...');
            document.getElementById('media-results').innerHTML = '';
            document.getElementById('subtitle-results').innerHTML = '';
            document.getElementById('media-section').style.display = 'none';
            document.getElementById('subtitle-section').style.display = 'none';

            try {
                const res = await fetch(`/api/search_media?query=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                hideFullscreenLoader();
                
                // Filter out items without either year or kind
                const filteredData = data.filter(item => item.year || item.kind);
                
                if (filteredData.length === 0) {
                    document.getElementById('media-section').style.display = 'block';
                    document.getElementById('media-results').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><p>No movies or series found. Try a different search term.</p></div>';
                    return;
                }

                document.getElementById('media-section').style.display = 'block';
                filteredData.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'media-item';
                    div.onclick = () => loadSubtitles(item.imdb_id, item.title, item.kind);
                    div.setAttribute('role', 'button');
                    div.setAttribute('tabindex', '0');
                    div.setAttribute('aria-label', `Select ${item.title}`);
                    
                    const img = item.cover 
                        ? `<img src="${item.cover}" alt="${item.title} poster">` 
                        : '<div class="placeholder-img">No Image</div>';
                    
                    div.innerHTML = `
                        ${img}
                        <div class="media-item-content">
                            <h4>${item.title}</h4>
                            <small>${item.year || 'N/A'} ¬∑ ${item.kind}</small>
                        </div>
                    `;
                    document.getElementById('media-results').appendChild(div);
                });

            } catch (error) {
                console.error(error);
                hideFullscreenLoader();
                alert('Error searching on IMDb. Please try again.');
            }
        }

        async function loadSubtitles(imdbId, title, kind) {
            showFullscreenLoader(`Loading subtitles for: ${title}...`);
            document.getElementById('subtitle-results').innerHTML = '';
            document.getElementById('subtitle-section').style.display = 'none';

            try {
                const res = await fetch(`/api/search_subtitles?imdb_id=${imdbId}&kind=${encodeURIComponent(kind)}`);
                const data = await res.json();
                const contentType = kind.toLowerCase().includes('serie') || kind.toLowerCase().includes('tv') ? 'series' : 'movie';

                hideFullscreenLoader();

                if (data.length === 0) {
                    document.getElementById('subtitle-section').style.display = 'block';
                    document.getElementById('subtitle-results').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>No English subtitles found for this content.</p></div>';
                    return;
                }

                // Sort by season and episode
                data.sort((a, b) => {
                    const sA = a.season_number || 0;
                    const sB = b.season_number || 0;
                    if (sA !== sB) return sA - sB;
                    
                    const eA = a.episode_number || 0;
                    const eB = b.episode_number || 0;
                    return eA - eB;
                });
                
                document.getElementById('subtitle-section').style.display = 'block';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'subtitle-item';
                    
                    let badge = '';
                    if (item.season_number) {
                        const s = item.season_number.toString().padStart(2, '0');
                        const e = item.episode_number ? item.episode_number.toString().padStart(2, '0') : '??';
                        badge = `<span class="badge">S${s}E${e}</span>`;
                    }

                    div.innerHTML = `
                        <div class="subtitle-info">
                            <div class="subtitle-title">${badge}${item.movie_name || title} (${item.year || 'N/A'})</div>
                            <div class="subtitle-meta">üìÅ ${item.file_name} ¬∑ ‚¨áÔ∏è ${item.downloads.toLocaleString()} downloads</div>
                        </div>
                        <button onclick="processSub('${item.file_id}', '${item.file_name}', '${imdbId}', '${(item.movie_name || title).replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${item.year || ''}', '${contentType}', '${item.season_number || ''}', '${item.episode_number || ''}')">Translate</button>
                    `;
                    document.getElementById('subtitle-results').appendChild(div);
                });
                
                document.getElementById('subtitle-section').scrollIntoView({behavior: 'smooth', block: 'nearest'});

            } catch (error) {
                console.error(error);
                hideFullscreenLoader();
                alert('Error loading subtitles. Please try again.');
            }
        }
        async function processSub(fileId, fileName, imdbId, title, year, contentType, seasonNum, episodeNum) {
            if (!confirm(`Do you want to translate "${fileName}" using AI and upload it automatically?`)) return;

            showFullscreenLoader(`Translating with AI (this may take a few minutes)...`);
            
            try {
                const payload = { 
                    file_id: parseInt(fileId), 
                    file_name: fileName,
                    imdb_id: imdbId,
                    title: title,
                    year: year,
                    content_type: contentType
                };

                if (seasonNum) payload.season_number = parseInt(seasonNum);
                if (episodeNum) payload.episode_number = parseInt(episodeNum);

                const res = await fetch('/api/process', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('Processing error');

                const data = await res.json();
                
                hideFullscreenLoader();
                
                if (data.status === 'success') {
                    alert('‚úÖ Success! ' + data.message);
                } else {
                    alert('‚ö†Ô∏è Warning: ' + data.message);
                }

            } catch (error) {
                console.error(error);
                hideFullscreenLoader();
                alert('‚ùå An error occurred during translation. Please try again.');
            }
        }
        
        function showFullscreenLoader(message) {
            const loader = document.getElementById('fullscreen-loader');
            const text = document.getElementById('loader-text');
            text.textContent = message;
            loader.className = 'fullscreen-loader active';
            document.body.classList.add('no-scroll');
        }
        
        function hideFullscreenLoader() {
            const loader = document.getElementById('fullscreen-loader');
            loader.className = 'fullscreen-loader';
            document.body.classList.remove('no-scroll');
        }
        
        function showLoading(message) {
            const loading = document.getElementById('loading');
            loading.innerHTML = `<span class="spinner"></span>${message}`;
            loading.className = 'loading active';
        }
        
        function hideLoading() {
            document.getElementById('loading').className = 'loading';
        }
        
        function showProcessing(message) {
            const processing = document.getElementById('processing');
            processing.innerHTML = `<span class="spinner"></span>${message}`;
            processing.className = 'loading active';
        }
        
        function hideProcessing() {
            document.getElementById('processing').className = 'loading';
        }
    </script>
    </script>
</body>
</html>
